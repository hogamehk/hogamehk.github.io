// ========== Firebase åˆå§‹åŒ– ==========
const firebaseConfig = {
  apiKey: "AIzaSyBycq_jVc6qJj24RR8d_OWfe_EPstfWF_o",
  authDomain: "uiduid-shop.firebaseapp.com",
  projectId: "uiduid-shop",
  storageBucket: "uiduid-shop.firebasestorage.app",
  messagingSenderId: "182307661971",
  appId: "1:182307661971:web:2d558690ca35e537498566",
  measurementId: "G-8QVTN6CE7D"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs,
  query,
  orderBy 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allProducts = [];

// ========== æ¸²æŸ“å•†å“å¡ç‰‡ ==========
function renderCards(data) {
  const container = document.getElementById('cardsGrid');
  if (!container) return;

  if (data.length === 0) {
    container.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">æ‰¾ä¸åˆ°å•†å“</p>';
    return;
  }

  container.innerHTML = '';
  data.forEach(card => {
    const name = card.name || 'æœªçŸ¥å•†å“';
    const image = card.image || 'images/placeholder-card.png';
    const hot = card.hot === true;

    const el = document.createElement('div');
    el.className = 'card-item';

    let badgeHTML = '';
    if (hot) {
      badgeHTML = '<div class="hot-badge">ç†±éŠ·</div>';
    }

    el.innerHTML = `
      <div class="card-image">
        <img 
          src="${image}" 
          alt="${name}"
          loading="lazy"
          onerror="this.onerror=null; this.src='images/placeholder-card.png';"
        />
      </div>
      <div class="card-info">
        <span class="card-name">${name}</span>
      </div>
      ${badgeHTML}
    `;
    
    el.addEventListener('click', () => {
      let url = 'product-detail.html?id=' + (card.id || 'unknown');
      if (card.detailPage) {
        url = card.detailPage;
      }
      window.location.href = url;
    });
    
    container.appendChild(el);
  });
}

// ========== è¼‰å…¥å•†å“ï¼ˆä½¿ç”¨ Firebase æ’åºï¼‰==========
async function loadProducts() {
  try {
    // ğŸ”¥ åœ¨æŸ¥è©¢æ™‚å°±æ’åºï¼ˆé«˜æ•ˆï¼ï¼‰
    const q = query(collection(db, "game_cards"), orderBy("order", "asc"));
    const querySnapshot = await getDocs(q);
    
    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${querySnapshot.size} ç­†å•†å“`);
    allProducts = [];
    querySnapshot.forEach(doc => {
      allProducts.push({ id: doc.id, ...doc.data() });
    });
    // âœ… ä¸éœ€è¦å‰ç«¯ sort() äº†
    renderCards(allProducts);
  } catch (error) {
    console.error("âŒ è®€å–å•†å“å¤±æ•—:", error);
    const container = document.getElementById('cardsGrid');
    if (container) {
      container.innerHTML = 
        '<p style="text-align:center; padding:20px; color:red;">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦</p>';
    }
  }
}

// ========== æœå°‹èˆ‡ç¯©é¸ ==========
function filterCards() {
  const keyword = document.getElementById('searchInput')?.value.toLowerCase() || '';
  const region = document.getElementById('regionFilter')?.value || '';

  const filtered = allProducts.filter(card => {
    const matchName = (card.name || '').toLowerCase().includes(keyword);
    const matchRegion = !region || card.region === region;
    return matchName && matchRegion;
  });

  renderCards(filtered);
}

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', () => {
  loadProducts();

  const searchInput = document.getElementById('searchInput');
  const regionFilter = document.getElementById('regionFilter');

  if (searchInput) {
    searchInput.addEventListener('input', filterCards);
  }
  if (regionFilter) {
    regionFilter.addEventListener('change', filterCards);
  }

  // å›åˆ°é ‚éƒ¨æŒ‰éˆ•
  const backToTop = document.getElementById('backToTop');
  if (backToTop) {
    window.addEventListener('scroll', () => {
      backToTop.classList.toggle('show', window.scrollY > 300);
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
});